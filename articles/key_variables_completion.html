<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Key variables completion • erikmisc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Key variables completion">
<meta property="og:description" content="erikmisc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">erikmisc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/key_variables_completion.html">Key variables completion</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/erikerhardt/erikmisc/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="key_variables_completion_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Key variables completion</h1>
            <h3 class="subtitle">Efficient completion of keys from multiple data sources</h3>
                        <h4 class="author">Prof. Erik Erhardt, PhD</h4>
            
            <h4 class="date">July 09, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/erikerhardt/erikmisc/blob/master/vignettes/key_variables_completion.Rmd"><code>vignettes/key_variables_completion.Rmd</code></a></small>
      <div class="hidden name"><code>key_variables_completion.Rmd</code></div>

    </div>

    
    
<!---
# Erik's compile commands in R:
  rm(list=ls())
  #dev.off(dev.list()["RStudioGD"])  # close all plots
  fn.this <- "key_variables_completion.Rmd"
  setwd("D:/Dropbox/StatAcumen/consult/Rpackages/gist/202103_key_variables")
  library(knitr)
  knitr::purl(fn.this)
  rmarkdown::render(fn.this)

# https://rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf
# http://haozhu233.github.io/kableExtra/awesome_table_in_pdf.pdf # tables
-->
<style>
/* HTML FORMATTING */
h1, .h1, h2, .h2, h3, .h3, h4, .h4, h5, .h5 {
  margin-top:  25px; /* space before each header */
  font-weight: bold; /* bold headers */
}
</style>
<div id="completing-combinations-of-key-variables" class="section level1">
<h1 class="hasAnchor">
<a href="#completing-combinations-of-key-variables" class="anchor"></a>Completing combinations of key variables</h1>
<p>Consider the data below. Let <code>a</code>, <code>b</code>, and <code>c</code> each be unique keys from a variety of data sources, where some data sources contain more than one of the keys, but not necessarily all of them at the same time. The goal is to complete the keys best by cross-referencing all other matching pairs.</p>
<p>For example, <code>a=1</code> and <code>b=11</code> appear together, and <code>a=1</code> and <code>c=10</code> appear together, therefore these three key values should appear together on the first two rows.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<p>Data and best key variables completion.</p>
<p><code>x</code> is a key variable but does not appear in this subset. The function handles empty keys, too.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># with data for key matching imputation</span>
<span class="va">dat_data</span> <span class="op">&lt;-</span>
  <span class="fu">tribble</span><span class="op">(</span>
    <span class="op">~</span><span class="va">a</span>, <span class="op">~</span><span class="va">b</span>, <span class="op">~</span><span class="va">c</span>, <span class="op">~</span><span class="va">x</span>, <span class="op">~</span><span class="va">d1</span>, <span class="op">~</span><span class="va">d2</span>
  ,  <span class="fl">1</span>, <span class="fl">11</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,   <span class="fl">1</span>,  <span class="fl">20</span>
  ,  <span class="fl">1</span>, <span class="cn">NA</span>, <span class="fl">10</span>, <span class="cn">NA</span>,   <span class="fl">2</span>,  <span class="fl">21</span>
  ,  <span class="fl">2</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,   <span class="fl">3</span>,  <span class="fl">22</span>
  , <span class="cn">NA</span>, <span class="fl">22</span>, <span class="fl">20</span>, <span class="cn">NA</span>,   <span class="fl">4</span>,  <span class="fl">23</span>
  ,  <span class="fl">2</span>, <span class="cn">NA</span>, <span class="fl">20</span>, <span class="cn">NA</span>,   <span class="fl">5</span>,  <span class="fl">24</span>
  ,  <span class="fl">3</span>, <span class="fl">33</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,   <span class="fl">6</span>,  <span class="fl">25</span>
  ,  <span class="fl">4</span>, <span class="cn">NA</span>, <span class="fl">40</span>, <span class="cn">NA</span>,   <span class="fl">7</span>,  <span class="fl">26</span>
  ,  <span class="fl">5</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,   <span class="fl">8</span>,  <span class="fl">27</span>
  ,  <span class="fl">6</span>, <span class="cn">NA</span>, <span class="fl">60</span>, <span class="cn">NA</span>,   <span class="fl">9</span>,  <span class="fl">28</span>
  ,  <span class="fl">6</span>, <span class="cn">NA</span>, <span class="fl">60</span>, <span class="cn">NA</span>,  <span class="fl">10</span>,  <span class="fl">29</span>
  , <span class="cn">NA</span>, <span class="fl">77</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,  <span class="fl">11</span>,  <span class="fl">30</span>
  , <span class="cn">NA</span>, <span class="fl">88</span>, <span class="fl">80</span>, <span class="cn">NA</span>,  <span class="fl">12</span>,  <span class="fl">31</span>
  , <span class="cn">NA</span>, <span class="fl">88</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,  <span class="fl">13</span>,  <span class="fl">32</span>
  , <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,  <span class="fl">14</span>,  <span class="fl">33</span>
  <span class="op">)</span>

<span class="co"># pre-determined best key variables completion</span>
<span class="va">dat_keys_pre</span> <span class="op">&lt;-</span>
  <span class="fu">tribble</span><span class="op">(</span>
    <span class="op">~</span><span class="va">a</span>, <span class="op">~</span><span class="va">b</span>, <span class="op">~</span><span class="va">c</span>, <span class="op">~</span><span class="va">x</span>
  ,  <span class="fl">1</span>, <span class="fl">11</span>, <span class="fl">10</span>, <span class="cn">NA</span>
  ,  <span class="fl">2</span>, <span class="fl">22</span>, <span class="fl">20</span>, <span class="cn">NA</span>
  ,  <span class="fl">3</span>, <span class="fl">33</span>, <span class="cn">NA</span>, <span class="cn">NA</span>
  ,  <span class="fl">4</span>, <span class="cn">NA</span>, <span class="fl">40</span>, <span class="cn">NA</span>
  ,  <span class="fl">5</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>
  ,  <span class="fl">6</span>, <span class="cn">NA</span>, <span class="fl">60</span>, <span class="cn">NA</span>
  , <span class="cn">NA</span>, <span class="fl">77</span>, <span class="cn">NA</span>, <span class="cn">NA</span>
  , <span class="cn">NA</span>, <span class="fl">88</span>, <span class="fl">80</span>, <span class="cn">NA</span>
  , <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>
  <span class="op">)</span></code></pre></div>
<div id="functions" class="section level2">
<h2 class="hasAnchor">
<a href="#functions" class="anchor"></a>Functions</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Combine rows with different data values</span>
<span class="va">f_coalesce_by_column</span> <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span>
    <span class="va">dat</span>
  <span class="op">)</span> <span class="op">{</span>
  <span class="co"># for matching group_by() keys, keeps first non-NA value for each column</span>

  <span class="co"># combine rows in data frame containing NA to make complete row</span>
  <span class="co"># https://stackoverflow.com/questions/45515218/combine-rows-in-data-frame-containing-na-to-make-complete-row</span>

  <span class="co">## use:</span>
  <span class="co">## dat %&gt;%</span>
  <span class="co">##   group_by(A) %&gt;%</span>
  <span class="co">##   summarise_all(f_coalesce_by_column)</span>


  <span class="co">## TESTING</span>
  <span class="co"># dat &lt;-</span>
  <span class="co">#   # A = 1, easy</span>
  <span class="co">#   # A = 2, easy</span>
  <span class="co">#   # A = 3, 3rd row has a dup and NA</span>
  <span class="co">#   # A = 4, 3rd row has conflucing info</span>
  <span class="co">#   tribble(</span>
  <span class="co">#    ~A, ~B, ~C, ~D, ~E</span>
  <span class="co">#   , 1, NA,  3, NA,  5</span>
  <span class="co">#   , 1,  2, NA,  2, NA</span>
  <span class="co">#   , 2, NA, NA,  3, NA</span>
  <span class="co">#   , 2,  4,  5, NA,  4</span>
  <span class="co">#   , 3, NA, NA,  3, NA</span>
  <span class="co">#   , 3,  4,  5, NA,  4</span>
  <span class="co">#   , 3,  4, NA, NA,  4</span>
  <span class="co">#   , 4, NA, NA,  3, NA</span>
  <span class="co">#   , 4,  4,  5, NA,  4</span>
  <span class="co">#   , 4, 99, 99, 99, NA</span>
  <span class="co">#   )</span>

  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html">coalesce</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>


<span class="co"># For a set of key variables that are unique for participants,</span>
<span class="co">#   identify sets of rows with unique key variables in common</span>
<span class="co">#   and collapse them together to have a single "most complete" row</span>
<span class="co">#   of key values by removing the NAs.</span>
<span class="co"># Each key variable must have a unique value for each participant.</span>
<span class="va">f_coalesce_column_set</span> <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span>
    <span class="va">dat</span>
  <span class="op">)</span> <span class="op">{</span>

  <span class="va">names_var</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>

  <span class="kw">for</span> <span class="op">(</span><span class="va">i_key</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">names_var</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="co">## i_key = 1</span>

    <span class="co"># rows for current column without NAs</span>
    <span class="va">dat_rows_process</span> <span class="op">&lt;-</span>
      <span class="va">dat</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[[</span><span class="va">i_key</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span>

    <span class="co"># bind to end to process later</span>
    <span class="va">dat_rows_skip_NA</span> <span class="op">&lt;-</span>
      <span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[[</span><span class="va">i_key</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span>

    <span class="co"># coalesce for this key column</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat_rows_process</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">dat_rows_process</span> <span class="op">&lt;-</span>
        <span class="va">dat_rows_process</span> <span class="op">%&gt;%</span>
        <span class="fu">group_by_at</span><span class="op">(</span>
          <span class="va">i_key</span>
        <span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">summarise_all</span><span class="op">(</span>
          <span class="va">f_coalesce_by_column</span>
        <span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span>
    <span class="op">}</span>

    <span class="co"># combine, assure original column order for iteration</span>
    <span class="va">dat</span> <span class="op">&lt;-</span>
      <span class="fu">bind_rows</span><span class="op">(</span>
        <span class="va">dat_rows_process</span>
      , <span class="va">dat_rows_skip_NA</span>
      <span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">select</span><span class="op">(</span>
        <span class="fu">one_of</span><span class="op">(</span><span class="va">names_var</span><span class="op">)</span>
      <span class="op">)</span>
  <span class="op">}</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="op">}</span>


<span class="co"># match and replace less complete rows with most complete row</span>
<span class="va">f_replace_keys_less_with_most_complete</span> <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span>
    <span class="va">dat_data</span>
  , <span class="va">dat_most_complete</span>
  , <span class="va">col_keys</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">{</span>

  <span class="co"># combination to match key variables, from most to least</span>
  <span class="va">dat_combination_var</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">col_keys</span><span class="op">)</span>
      , <span class="fl">0</span><span class="op">:</span><span class="fl">1</span>
      , simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="va">dat_combination_var</span><span class="op">$</span><span class="va">s</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">dat_combination_var</span><span class="op">)</span>
  <span class="va">dat_combination_var</span> <span class="op">&lt;-</span>
    <span class="va">dat_combination_var</span> <span class="op">%&gt;%</span>
    <span class="fu">arrange</span><span class="op">(</span>
      <span class="op">-</span><span class="va">s</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span>
      <span class="op">-</span><span class="va">s</span>
    <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat_combination_var</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">col_keys</span>

  <span class="co"># dat_combination_var</span>

  <span class="co"># list to fill with matches, then bind at end</span>
  <span class="va">dat_data_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">dat_data_in</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>

  <span class="kw">for</span> <span class="op">(</span><span class="va">i_combination</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat_combination_var</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="co">## i_combination = 1</span>
    <span class="co">## i_combination = 2</span>

    <span class="co"># keep track of which rows to include and exclude for this combination</span>
    <span class="va">ind_all</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dat_data</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">col_keys</span><span class="op">)</span><span class="op">)</span>

    <span class="va">keys_include</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">dat_combination_var</span><span class="op">[</span><span class="va">i_combination</span>, <span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>

    <span class="kw">for</span> <span class="op">(</span><span class="va">i_col_keys</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">col_keys</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="co">## i_col_keys = 1</span>

      <span class="kw">if</span> <span class="op">(</span><span class="va">keys_include</span><span class="op">[</span><span class="va">i_col_keys</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>
        <span class="co"># values for these keys</span>
        <span class="va">ind_all</span><span class="op">[</span>, <span class="va">i_col_keys</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dat_data</span><span class="op">[[</span> <span class="va">col_keys</span><span class="op">[</span><span class="va">i_col_keys</span><span class="op">]</span> <span class="op">]</span><span class="op">]</span><span class="op">)</span>
      <span class="op">}</span>
      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">keys_include</span><span class="op">[</span><span class="va">i_col_keys</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>
        <span class="co"># NAs for these col_keys</span>
        <span class="va">ind_all</span><span class="op">[</span>, <span class="va">i_col_keys</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dat_data</span><span class="op">[[</span> <span class="va">col_keys</span><span class="op">[</span><span class="va">i_col_keys</span><span class="op">]</span> <span class="op">]</span><span class="op">]</span><span class="op">)</span>
      <span class="op">}</span>

    <span class="op">}</span>

    <span class="co"># identify rows for this combination</span>
    <span class="va">ind_combination</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">ind_all</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">col_keys</span><span class="op">)</span>

    <span class="va">dat_data_in</span><span class="op">[[</span><span class="va">i_combination</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>
      <span class="va">dat_data</span><span class="op">[</span><span class="va">ind_combination</span>,<span class="op">]</span>

    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">keys_include</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">dat_data_out</span><span class="op">[[</span><span class="va">i_combination</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>
        <span class="va">dat_data_in</span><span class="op">[[</span><span class="va">i_combination</span><span class="op">]</span><span class="op">]</span>

    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>

      <span class="va">dat_data_out</span><span class="op">[[</span><span class="va">i_combination</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>
        <span class="fu">right_join</span><span class="op">(</span>
          <span class="va">dat_most_complete</span>
        , <span class="va">dat_data_in</span><span class="op">[[</span><span class="va">i_combination</span><span class="op">]</span><span class="op">]</span>
        , by <span class="op">=</span> <span class="va">col_keys</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">keys_include</span><span class="op">)</span><span class="op">]</span>
        , suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">".EMPTY"</span><span class="op">)</span>
        , keep <span class="op">=</span> <span class="cn">FALSE</span>
        <span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">select</span><span class="op">(</span>
          <span class="op">-</span><span class="fu">ends_with</span><span class="op">(</span><span class="st">".EMPTY"</span><span class="op">)</span>
        <span class="op">)</span>
    <span class="op">}</span>

  <span class="op">}</span>

  <span class="co"># combine all results</span>
  <span class="va">dat_data_updated</span> <span class="op">&lt;-</span>
    <span class="fu">bind_rows</span><span class="op">(</span>
      <span class="va">dat_data_out</span>
    <span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dat_data_updated</span><span class="op">)</span>
<span class="op">}</span>


<span class="co">#' Complete multiple key ID variables</span>
<span class="co">#'</span>
<span class="co">#' When data are combined from multiple sources and multiple identifier keys (ID)</span>
<span class="co">#' are used, sometimes in combinations, then we may want to provide the</span>
<span class="co">#' most complete set of the IDs for each observation.</span>
<span class="co">#' By definition, each key value is unique within its column to identify an observational unit.</span>
<span class="co">#'</span>
<span class="co">#' @param dat_data data frame with a set of variables that are keys</span>
<span class="co">#' @param dat_keys optional data frame with only key variables, more complete than set in dat_data</span>
<span class="co">#' @param col_keys key columns names</span>
<span class="co">#'</span>
<span class="co">#' @return dat_data with updated key columns</span>
<span class="co">#' @export</span>
<span class="co">#'</span>
<span class="co">#' @examples</span>
<span class="co">#'</span>
<span class="co">#' dat_data &lt;-</span>
<span class="co">#'   tribble(</span>
<span class="co">#'     ~a, ~b, ~c, ~d1, ~d2</span>
<span class="co">#'   ,  1, 11, NA,   1,  20</span>
<span class="co">#'   ,  1, NA, 10,   2,  21</span>
<span class="co">#'   ,  2, NA, NA,   3,  22</span>
<span class="co">#'   , NA, 22, 20,   4,  23</span>
<span class="co">#'   ,  2, NA, 20,   5,  24</span>
<span class="co">#'   ,  3, 33, NA,   6,  25</span>
<span class="co">#'   ,  4, NA, 40,   7,  26</span>
<span class="co">#'   ,  5, NA, NA,   8,  27</span>
<span class="co">#'   ,  6, NA, 60,   9,  28</span>
<span class="co">#'   ,  6, NA, 60,  10,  29</span>
<span class="co">#'   , NA, 77, NA,  11,  30</span>
<span class="co">#'   , NA, 88, 80,  12,  31</span>
<span class="co">#'   , NA, 88, NA,  13,  32</span>
<span class="co">#'   , NA, NA, NA,  14,  33</span>
<span class="co">#'   )</span>
<span class="co">#'</span>
<span class="co">#' dat_data_updated &lt;-</span>
<span class="co">#'   f_complete_multiple_keys(</span>
<span class="co">#'     dat_data</span>
<span class="co">#'   , dat_keys = NULL</span>
<span class="co">#'   , col_keys = c("a", "b", "c")</span>
<span class="co">#'   )</span>
<span class="co">#'</span>
<span class="co">#' dat_data_updated %&gt;% print(n=Inf)</span>
<span class="co">#'</span>
<span class="va">f_complete_multiple_keys</span> <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span>
    <span class="va">dat_data</span>
  , <span class="va">dat_keys</span> <span class="op">=</span> <span class="cn">NULL</span>
  , <span class="va">col_keys</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">{</span>

  <span class="co"># create ID to restore original row order at end</span>
  <span class="va">dat_data</span> <span class="op">&lt;-</span>
    <span class="va">dat_data</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>
      .ID. <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span>

  <span class="co"># create complete keys</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">dat_keys</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">dat_keys</span> <span class="op">&lt;-</span>
      <span class="fu">f_coalesce_column_set</span><span class="op">(</span>
        <span class="va">dat_data</span> <span class="op">%&gt;%</span>
        <span class="fu">select</span><span class="op">(</span>
          <span class="fu">one_of</span><span class="op">(</span><span class="va">col_keys</span><span class="op">)</span>
        <span class="op">)</span>
      <span class="op">)</span>
  <span class="op">}</span>

  <span class="co"># update data with complete keys</span>
  <span class="va">dat_data_updated</span> <span class="op">&lt;-</span>
    <span class="fu">f_replace_keys_less_with_most_complete</span><span class="op">(</span>
      dat_data          <span class="op">=</span> <span class="va">dat_data</span>
    , dat_most_complete <span class="op">=</span> <span class="va">dat_keys</span>
    , col_keys          <span class="op">=</span> <span class="va">col_keys</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># restore original row order</span>
    <span class="fu">arrange</span><span class="op">(</span>
      <span class="va">.ID.</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span>
      <span class="op">-</span><span class="va">.ID.</span>
    <span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dat_data_updated</span><span class="op">)</span>

<span class="op">}</span></code></pre></div>
</div>
</div>
<div id="results" class="section level1">
<h1 class="hasAnchor">
<a href="#results" class="anchor"></a>Results</h1>
<div id="test-key-completion" class="section level2">
<h2 class="hasAnchor">
<a href="#test-key-completion" class="anchor"></a>Test key completion</h2>
<p>Print data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat_data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span></code></pre></div>
<pre><code># A tibble: 14 x 6
       a     b     c x        d1    d2
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1     1    11    NA NA        1    20
 2     1    NA    10 NA        2    21
 3     2    NA    NA NA        3    22
 4    NA    22    20 NA        4    23
 5     2    NA    20 NA        5    24
 6     3    33    NA NA        6    25
 7     4    NA    40 NA        7    26
 8     5    NA    NA NA        8    27
 9     6    NA    60 NA        9    28
10     6    NA    60 NA       10    29
11    NA    77    NA NA       11    30
12    NA    88    80 NA       12    31
13    NA    88    NA NA       13    32
14    NA    NA    NA NA       14    33</code></pre>
<p>Computing the best key variables completion.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat_keys</span> <span class="op">&lt;-</span>
  <span class="fu">f_coalesce_column_set</span><span class="op">(</span><span class="va">dat_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="va">dat_keys</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span></code></pre></div>
<pre><code># A tibble: 9 x 4
      a     b     c x    
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;
1     1    11    10 NA   
2     2    22    20 NA   
3     4    NA    40 NA   
4     6    NA    60 NA   
5    NA    88    80 NA   
6     3    33    NA NA   
7    NA    77    NA NA   
8     5    NA    NA NA   
9    NA    NA    NA NA   </code></pre>
<p>Pre-determined best key variables completion.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat_keys_pre</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span></code></pre></div>
<pre><code># A tibble: 9 x 4
      a     b     c x    
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;
1     1    11    10 NA   
2     2    22    20 NA   
3     3    33    NA NA   
4     4    NA    40 NA   
5     5    NA    NA NA   
6     6    NA    60 NA   
7    NA    77    NA NA   
8    NA    88    80 NA   
9    NA    NA    NA NA   </code></pre>
<p>They are equal.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat_keys</span>      <span class="op">&lt;-</span> <span class="va">dat_keys</span>     <span class="op">%&gt;%</span> <span class="fu">arrange</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span>, <span class="va">x</span><span class="op">)</span>
<span class="va">dat_keys_pre</span>  <span class="op">&lt;-</span> <span class="va">dat_keys_pre</span> <span class="op">%&gt;%</span> <span class="fu">arrange</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span>, <span class="va">x</span><span class="op">)</span>
<span class="fu">all_equal</span><span class="op">(</span><span class="va">dat_keys_pre</span>, <span class="va">dat_keys</span><span class="op">)</span></code></pre></div>
<pre><code>[1] TRUE</code></pre>
</div>
<div id="best-key-variables-completion-with-data" class="section level2">
<h2 class="hasAnchor">
<a href="#best-key-variables-completion-with-data" class="anchor"></a>Best key variables completion with data</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat_data_updated</span> <span class="op">&lt;-</span>
  <span class="fu">f_complete_multiple_keys</span><span class="op">(</span>
    <span class="va">dat_data</span>
  , dat_keys <span class="op">=</span> <span class="cn">NULL</span>
  , col_keys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>, <span class="st">"x"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">dat_data_updated</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span></code></pre></div>
<pre><code># A tibble: 14 x 6
       a     b     c x        d1    d2
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1     1    11    10 NA        1    20
 2     1    11    10 NA        2    21
 3     2    22    20 NA        3    22
 4     2    22    20 NA        4    23
 5     2    22    20 NA        5    24
 6     3    33    NA NA        6    25
 7     4    NA    40 NA        7    26
 8     5    NA    NA NA        8    27
 9     6    NA    60 NA        9    28
10     6    NA    60 NA       10    29
11    NA    77    NA NA       11    30
12    NA    88    80 NA       12    31
13    NA    88    80 NA       13    32
14    NA    NA    NA NA       14    33</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Erik Erhardt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
